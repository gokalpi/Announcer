function start(){connection.start().then(function(){connection.state===signalR.HubConnectionState.Connected&&(console.log("Connected to hub at "+hubUri),getClientInfo(clientId))}).catch(n=>{displayError(n),connection.state===signalR.HubConnectionState.Disconnected&&setTimeout(()=>start(),5e3)})}function joinGroup(n){n&&connection.invoke("AddToGroupAsync",n).then(function(){}).catch(n=>displayError(n))}function leaveGroup(n){n&&connection.invoke("RemoveFromGroupAsync",n).then(function(){}).catch(n=>displayError(n))}function displayClock(){let n=document.getElementById("clock");n&&(n.innerText=new Intl.DateTimeFormat("tr-TR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date));setTimeout(function(){displayClock()},1e3)}function displayError(n){var t=document.getElementById("error-pane"),i=document.getElementById("error-message");i.innerText=n;t.style=""}function displayHeaders(n){var t,i;n&&(t=document.getElementById("notifications-header"),t&&(t.querySelectorAll("*").forEach(n=>n.remove()),infoColumnCount=n.columns.length>0?n.columns.length-1:0,i=document.createDocumentFragment(),n.columns.forEach(n=>{let t=document.createElement("div");t.innerHTML=n;i.appendChild(t)}),t.appendChild(i)))}function displayLastUpdate(){let n=document.getElementById("last-update");n&&(n.innerText=new Intl.DateTimeFormat("tr-TR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date))}function displayNotification(n,t){var f=JSON.parse(t),a=slugify(n),l=`group-${a}`,i=document.getElementById(l),h,r,c,e,o,u,s;if(i){for(h=i.getElementsByClassName("group-col"),r=0;r<h.length;r++)f.columns[r]&&(h[r].innerHTML=f.columns[r]);i.className="notification-item active";setTimeout(()=>i.className="notification-item",6500)}else if(c=document.getElementById("notifications"),c){for(i=document.createElement("div"),i.id=l,i.className="notification-item active",setTimeout(()=>i.className="notification-item",6500),e=document.createDocumentFragment(),o=document.createElement("div"),o.className="group-name",o.innerHTML=n,e.appendChild(o),u=0;u<infoColumnCount;u++)s=document.createElement("div"),s.className="group-col",f.columns[u]&&(s.innerHTML=f.columns[u]),e.appendChild(s);i.appendChild(e);c.appendChild(i)}i&&displayLastUpdate()}function getClientInfo(n){if(!n)return null;fetch(`${clientUri}/${n}`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(n){if(!n.ok)throw Error(`${n.status} status code received.`);return n.json()}).then(function(t){if(t.isSuccessful){let r=t.model;if(r.template){let t=JSON.parse(r.template);if(displayHeaders(t.header),r.groups&&r.groups.length>0){groups=r.groups.map(n=>n.group).sort();for(var i=0;i<groups.length;i++)displayNotification(groups[i],'{ "columns": [ "", "" ] }'),joinGroup(groups[i]);getNotifications(n)}else displayError("İstemcinin üye olduğu gruplar bulunamadı.")}}else displayError("İstemci bilgisi okunamadı. "+t.message)}).catch(n=>{displayError("İstemci bilgisi bulunamadı. "+n)})}function getNotifications(n){n&&fetch(`${clientUri}/${n}/GroupNotifications`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(n){if(!n.ok)throw Error(`${n.status} status code received.`);return n.json()}).then(function(n){if(n.isSuccessful){let i=n.model;for(var t=0;t<i.length;t++)displayNotification(i[t].group,i[t].content)}else displayError("İstemcinin mesajları okunamadı. "+n.message)}).catch(n=>{displayError("İstemcinin mesajları bulunamadı. "+n)})}function setClientId(n){var t;if(n&&n.trim().length>0)t=n;else{const n=new URLSearchParams(window.location.search);t=n.get("id");t&&t.trim().length!==0||(t=clientIP)}return t&&t.trim().length>0?(t=t.trim(),document.getElementById("client-id").innerText=t,t):(displayError("İstemci bilgisi bulunamadı"),null)}function slugify(n){var t={"çÇ":"c","ğĞ":"g","şŞ":"s","üÜ":"u","ıİ":"i","öÖ":"o"};for(var i in t)n=n.replace(new RegExp("["+i+"]","g"),t[i]);return n.replace(/[^-a-zA-Z0-9\s]+/ig,"").replace(/\s/gi,"-").replace(/[-]+/gi,"-").toLowerCase()}var hubUri="/NotificationHub",clientUri="/api/Clients",infoColumnCount=0,groups,qrCodeUri=location.href,qrcode=new QRCode(document.getElementById("qrcode"),{text:qrCodeUri,width:100,height:100}),connection=(new signalR.HubConnectionBuilder).withUrl(hubUri).withAutomaticReconnect().configureLogging(signalR.LogLevel.Error).build();connection.onreconnecting(n=>{var i,t,u,r;for(console.log("Reconnecting"),document.getElementById("loader-wrapper").hidden=!1,i=document.getElementsByClassName("notification-item"),t=0;t<i.length;t++)for(i[t].className="notification-item disconnected",u=i[t].getElementsByClassName("group-col"),r=0;r<u.length;r++)u[r].innerHTML="";console.assert(connection.state===signalR.HubConnectionState.Reconnecting);console.warn(`Connection lost due to error "${n}". Reconnecting.`)});connection.onreconnected(n=>{var i,t;for(console.log("Reconnected"),document.getElementById("loader-wrapper").hidden=!0,i=document.getElementsByClassName("notification-item"),t=0;t<i.length;t++)i[t].className="notification-item";console.assert(connection.state===signalR.HubConnectionState.Connected);getClientInfo(clientId);console.warn(`Connection reestablished and joined to the groups. Connected with connectionId "${n}".`)});connection.onclose(n=>{if(console.assert(connection.state===signalR.HubConnectionState.Disconnected),groups)for(var t=0;t<groups.length;t++)console.log("On close - leaving groups[%d]: %o",t,groups[t]),leaveGroup(groups[t]);console.warn("Connection closed due to error "+n+". Try refreshing this page to restart the connection.")});connection.on("UserConnected",function(n){console.log(`Client connected with connection id "${n}"`)});connection.on("UserDisconnected",function(n,t){console.log(`Client disconnected with connection id "${t}"`)});connection.on("JoinedGroup",function(n,t){console.log(`Client "${n}" joined to group "${t}"`)});connection.on("LeftGroup",function(n,t){console.log(`Client "${n}" left group "${t}"`)});connection.on("ReceiveGroupMessage",function(n){displayNotification(n.group,n.message)});connection.on("ReceiveMessage",function(n){var t=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");console.log(t)});